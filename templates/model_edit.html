{% extends "base.html" %}
{% block title %}モデル編集 — {{ model.name }}{% endblock %}

{% block content %}
<div class="mx-auto max-w-5xl p-6">
  <h1 class="page-title">モデル編集</h1>
  <p class="muted">既に設定している値をフォームに反映しています。空欄の項目は変更しません。</p>

  <div class="card" style="margin-bottom:16px">
    <div class="flex-row" style="display:flex; gap:16px; align-items:center;">
      <div class="thumb-lg">
        {% if model.icon_path %}
          <img src="/media/models/{{ model.uuid }}/icon" alt="icon" style="width:96px; height:96px; object-fit:cover; border-radius:12px;">
        {% else %}
          <img src="/static/defaults/model.svg" alt="icon" style="width:96px; height:96px; object-fit:cover; border-radius:12px;">
        {% endif %}
      </div>
      <div>
        <div class="model-title">
          {{ model.name }}
          {% if model.is_locked %}
            <!-- 施錠中の鍵アイコン（SVG） -->
            <svg viewBox="0 0 24 24" width="18" height="18" style="vertical-align:-3px; margin-left:6px; fill:#f59e0b;">
              <path d="M12 1a5 5 0 00-5 5v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V6a5 5 0 00-5-5zm-3 8V6a3 3 0 016 0v3H9zm3 4a2 2 0 110 4 2 2 0 010-4z"/>
            </svg>
          {% endif %}
          {% if model.is_certified %}
            <!-- 認証マーク（SVG） -->
            <svg viewBox="0 0 24 24" width="18" height="18" style="vertical-align:-3px; margin-left:6px; fill:#34d399;">
              <path d="M12 2l2.39 4.84L20 8.27l-3.91 3.81L16.78 18 12 15.64 7.22 18l.69-5.92L4 8.27l5.61-1.43L12 2z"/>
            </svg>
          {% endif %}
        </div>
        <div class="muted">UUID: {{ model.uuid }}</div>
      </div>
    </div>
  </div>

  <form id="edit-form" class="form" method="post" action="/models/{{ model.uuid }}/edit" enctype="multipart/form-data">
    <!-- 基本情報 -->
    <section class="section">
      <h2 class="section-title">基本情報</h2>
      <div class="grid-2">
        <label class="field">
          <span class="label">モデル名</span>
          <input type="text" name="name" value="{{ model.name|e }}" placeholder="空欄のまま送信すると変更しません">
        </label>

        <label class="field">
          <span class="label">ライセンス（テンプレート）</span>
          <select name="license_name" id="license_name">
            {% for key, label in license_templates.items() %}
              <option value="{{ key }}" {% if model.license_name==key %}selected{% endif %}>{{ label }}（{{ key }}）</option>
            {% endfor %}
          </select>
          <small class="muted">テンプレートを変えても、本文を空欄で送れば既存の本文は据え置き。</small>
        </label>
      </div>

      <label class="field">
        <span class="label">説明文</span>
        <textarea name="description" rows="5" placeholder="空欄のまま送信すると変更しません">{{ model.description|e }}</textarea>
      </label>

      <label class="field">
        <span class="label">ライセンス本文</span>
        <textarea name="license_text" id="license_text" rows="8" placeholder="空欄のまま送信すると変更しません">{{ model.license_text|e }}</textarea>
      </label>

      <label class="field" style="margin-top:6px;">
        <span class="label">公開設定</span>
        <!-- 未チェック時も値が送られるように hidden で false を先送信、checkbox が後勝ち -->
        <input type="hidden" name="is_public" value="false">
        <label class="inline">
          <input type="checkbox" name="is_public" value="true" {% if model.is_public %}checked{% endif %}> このモデルを公開する
        </label>
        <div class="muted">未変更にしたい場合は、チェック状態は現状に合わせたまま送信してください。</div>
      </label>
    </section>

    <!-- 現在のサンプル（旧方式・単体） -->
    <!-- <section class="section">
      <h2 class="section-title">現在のサンプル（旧方式・単体）</h2>
        <div class="field">
          <span class="label">サンプル画像（単体）</span>
          <div class="thumb-md">
            {% if sample_icon_available %}
              <img src="{{ sample_icon_url }}" alt="sample icon" style="width:160px; height:160px; object-fit:cover; border-radius:12px;">
            {% else %}
              <img src="/static/defaults/model.svg" alt="no sample icon" style="width:160px; height:160px; object-fit:cover; border-radius:12px;">
            {% endif %}
          </div>
          <small class="muted">上書きしたい場合は下の「手動メディア」で新しいファイルを選択してください。</small>
        </div>
    </section> -->

    <!-- 手動メディア（上書き・追加） -->
    <section class="section">
      <h2 class="section-title">手動メディア（上書き・追加）</h2>
      <!-- <div class="grid-3"> -->
        <label class="field">
          <span class="label">モデルアイコン（上書き・単体）</span>
          <input type="file" name="icon" accept="image/*">
        </label>
        <!-- <label class="field">
          <span class="label">サンプル画像（上書き・単体）</span>
          <input type="file" name="sample_icon" accept="image/*">
        </label> -->
        <!-- <label class="field">
          <span class="label">サンプル音声（上書き・単体）</span>
          <input type="file" name="sample_audio" accept="audio/*">
        </label> -->
      <!-- </div> -->

      <!-- <div class="grid-2" style="margin-top:10px;"> -->
        <!-- <label class="field">
          <span class="label">サンプル画像（複数追加）</span>
          <input type="file" id="sample_images" name="sample_images" accept="image/*" multiple>
          <div id="preview_images" class="preview-list"></div>
          <small class="muted">選択分が「追加」されます（既存は保持されます）。</small>
        </label> -->
        <label class="field">
          <span class="label">サンプル音声（複数追加）</span>
          <input type="file" id="sample_audios" name="sample_audios" accept="audio/*" multiple>
          <div id="preview_audios" class="preview-list"></div>
          <small class="muted">選択分が「追加」されます（既存は保持されます）。</small>
        </label>
      <!-- </div> -->
    </section>

    <!-- 送信 -->
    <div class="actions">
      <button id="submit-btn" class="btn primary" type="submit">保存する</button>
      <a class="btn ghost" href="/models/{{ model.uuid }}">キャンセル</a>
      <span id="saving-tip" class="muted" style="display:none;">保存中…</span>
    </div>
  </form>

  <div class="card" style="margin-top:16px;">
    <h3 class="section-title">現在の公開状態と統計</h3>
    <div class="muted">公開: {{ 'はい' if model.is_public else 'いいえ' }}</div>
    <div class="muted">ダウンロード数: {{ model.downloads }}</div>
    <div class="muted">いいね数: {{ model.likes_count }}</div>
    <div class="muted">作成: {{ model.created_at }} / 更新: {{ model.updated_at }}</div>
  </div>
</div>
<!-- サンプル音声削除フォームは編集フォームの外に独立させる -->
{% if edit_sample_audios and edit_sample_audios|length > 0 %}
<div class="card" style="margin-top:24px;">
  <section class="section">
    <h2 class="section-title">サンプル音声（追加済み・複数）を削除</h2>
    <form method="post" action="/models/{{ model.uuid }}/samples/delete"
          onsubmit="return confirm('選択したサンプル音声を削除します。よろしいですか？');">
      <div class="audio-list">
        {% for au in edit_sample_audios %}
          <div class="audio-row">
            <label class="audio-check">
              <input type="checkbox" name="delete_audio_ids" value="{{ au.uuid }}">
              <span class="muted">#{{ au.sort_order }}</span>
            </label>
            <audio controls src="/media/models/{{ model.uuid }}/samples/{{ au.uuid }}"></audio>
          </div>
        {% endfor %}
      </div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn danger" type="submit">選択したサンプル音声を削除</button>
      </div>
    </form>
  </section>
</div>
{% endif %}
<style>
  .page-title { font-size: 1.8rem; font-weight: 700; margin-bottom: .5rem; }
  .muted { color: #6b7280; font-size: .9rem; }
  .card { background: var(--card, #101114); border: 1px solid #24262b; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
  .field .label { display:block; font-weight:600; margin-bottom:6px; }
  .field input[type="text"], .field textarea, .field select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #31343a; background: #0b0c0f; color: #e5e7eb; }
  .field textarea { resize: vertical; }
  .req { color: #ef4444; }
  .actions { display:flex; align-items:center; gap: 12px; margin-top: 8px; }
  .btn { padding: 10px 16px; border-radius: 999px; border: 1px solid #2c2f35; background: #13141a; color: #e5e7eb; cursor:pointer; }
  .btn.primary { background: linear-gradient(135deg, #6ea8fe, #9b8cff); border-color: transparent; }
  .btn.ghost { background: transparent; }
  .btn.danger { background:#7f1d1d; border-color:#7f1d1d; }
  .dropzone { border: 2px dashed #30343c; border-radius: 16px; padding: 18px; background: #0b0d12; position: relative; }
  .dropzone input[type="file"] { width:100%; padding:12px; border-radius:10px; background:#0b0c0f; border:1px solid #31343a; color:#e5e7eb; }
  .dz-instructions { display:flex; gap: 14px; align-items:center; margin-top: 8px; color:#9ca3af; }
  .dz-icon { font-size: 1.6rem; }
  .dz-title { font-weight:700; }
  .dz-sub { font-size:.9rem; }
  .preview-list { margin-top: 8px; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap: 8px; }
  .chip { font-size:.85rem; background:#111318; border:1px solid #2b2f36; padding:6px 10px; border-radius:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .audio-list { display:flex; flex-direction:column; gap:10px; }
  .audio-row { display:grid; grid-template-columns: auto 1fr auto; gap:10px; align-items:center; background:#0d0f14; border:1px solid #262a31; padding:10px; border-radius:10px; }
  .audio-check { display:flex; align-items:center; gap:8px; }
  .audio-row audio { width:100%; }
  .audio-row .path { font-size:.8rem; color:#6b7280; }
  /* 進捗バー */
  .progress-wrap { margin-top: 10px; }
  .progress { width:100%; height: 14px; background:#0f1116; border:1px solid #2c2f35; border-radius: 999px; overflow: hidden; }
  .progress-bar { height:100%; background: linear-gradient(90deg, #6ea8fe, #9b8cff); transition: width .15s ease; }
  .progress-meta { display:flex; gap:12px; align-items:center; margin-top:6px; }
  #progress-text { font-weight:700; }
</style>

<script>
(function(){
  const form = document.getElementById('edit-form');
  const submitBtn = document.getElementById('submit-btn');
  const tip = document.getElementById('saving-tip');

  form.addEventListener('submit', function(){
    submitBtn.disabled = true;
    submitBtn.textContent = '保存中…';
    tip.style.display = 'inline';
  });

  function bindPreview(inputId, previewId) {
    const input = document.getElementById(inputId);
    const box = document.getElementById(previewId);
    if (!input || !box) return;
    input.addEventListener('change', function(){
      box.innerHTML = '';
      if (!this.files) return;
      Array.from(this.files).forEach(f => {
        const div = document.createElement('div');
        div.className = 'chip';
        div.textContent = f.name + ' (' + Math.round(f.size/1024) + 'KB)';
        box.appendChild(div);
      });
    });
  }
  // bindPreview('sample_images', 'preview_images');
  bindPreview('sample_audios', 'preview_audios');
})();
</script>
{% endblock %}
