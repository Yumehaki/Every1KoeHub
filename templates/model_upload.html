{% extends "base.html" %}
{% block title %}ãƒ¢ãƒ‡ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰{% endblock %}

{% block content %}
<div class="mx-auto max-w-4xl p-6">
  <h1 class="page-title">ãƒ¢ãƒ‡ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>
  <p class="muted">
    AIVMXãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.aivmxï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ã€æ‰‹å‹•ã®ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ã‚µãƒ³ãƒ—ãƒ«ç”»åƒï¼éŸ³å£°ã‚’è¿½åŠ ã§ãã¾ã™ã€‚
    æŠ½å‡ºã«æˆåŠŸã—ãŸå ´åˆã¯ã€.aivmx å†…ã®ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ã‚µãƒ³ãƒ—ãƒ«ãŒè‡ªå‹•ã§åˆæœŸè¨­å®šã•ã‚Œã¾ã™ã€‚
  </p>
<br>
  <form id="upload-form" class="form" method="post" action="/models/upload" enctype="multipart/form-data">
    <!-- åŸºæœ¬æƒ…å ± -->
    <section class="section">
      <h2 class="section-title">åŸºæœ¬æƒ…å ±</h2>
      <div class="grid-2">
        <label class="field">
          <span class="label">ãƒ¢ãƒ‡ãƒ«å <span class="req">*</span></span>
          <input type="text" name="name" required placeholder="ä¾‹: Every1Koe JP Voice v1">
        </label>
        <br>
        <label class="field">
          <span class="label">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰</span>
          <select name="license_name" id="license_name">
            {% for key, label in license_templates.items() %}
              <option value="{{ key }}">{{ label }}ï¼ˆ{{ key }}ï¼‰</option>
            {% endfor %}
          </select>
          <small class="muted">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸ã¶ã¨ã€Œãƒ©ã‚¤ã‚»ãƒ³ã‚¹æœ¬æ–‡ã€ã¯ä»»æ„ã§è¿½è¨˜ãƒ»ä¸Šæ›¸ãã§ãã¾ã™ã€‚</small>
        </label>
        <br>
      </div>
      <br>
      <label class="field">
        <span class="label">èª¬æ˜æ–‡</span>
        <textarea name="description" rows="5" placeholder="ãƒ¢ãƒ‡ãƒ«ã®æ¦‚è¦ã€ç”¨é€”ã€æ³¨æ„ç‚¹ãªã©"></textarea>
      </label>
      <br>
      <label class="field">
        <span class="label">ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æœ¬æ–‡ï¼ˆä»»æ„ï¼‰</span>
        <textarea name="license_text" id="license_text" rows="8" placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæœ¬æ–‡ã®è¿½è¨˜ã‚„ç‹¬è‡ªãƒ©ã‚¤ã‚»ãƒ³ã‚¹æœ¬æ–‡ã‚’è¨˜è¼‰"></textarea>
      </label>
    </section>

    <!-- AIVMX ãƒ•ã‚¡ã‚¤ãƒ« -->
    <section class="section">
      <h2 class="section-title">AIVMX ãƒ•ã‚¡ã‚¤ãƒ«</h2>
      <div class="dropzone" id="aivmx-drop">
        <input type="file" id="aivmx" name="file" accept=".aivmx,application/zip" required>
        <div class="dz-instructions">
          <div class="dz-icon">ğŸ“¦</div>
          <div>
            <div class="dz-title">AIVMX ã‚’é¸æŠ / ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
            <div class="dz-sub">æ‹¡å¼µå­ .aivmxï¼ˆZIPäº’æ›ï¼‰</div>
          </div>
        </div>
      </div>
      <small class="muted">â€» ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã€è‡ªå‹•çš„ã«ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ã‚µãƒ³ãƒ—ãƒ«ï¼ˆç”»åƒ/éŸ³å£°ï¼‰ã‚„ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®æŠ½å‡ºã‚’è©¦ã¿ã¾ã™ã€‚</small>
    </section>

    <!-- æ‰‹å‹•ãƒ¡ãƒ‡ã‚£ã‚¢ï¼ˆæŠ½å‡ºã«å¤±æ•—/ä¸Šæ›¸ãã—ãŸã„å ´åˆï¼‰ -->
    <section class="section">
      <h2 class="section-title">æ‰‹å‹•ãƒ¡ãƒ‡ã‚£ã‚¢ï¼ˆä»»æ„ï¼‰</h2>
      <div class="grid-3">
        <label class="field">
          <span class="label">ãƒ¢ãƒ‡ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆå˜ä½“ï¼‰</span>
          <input type="file" name="icon" accept="image/*">
          <small class="muted">.aivmxã®ã‚¢ã‚¤ã‚³ãƒ³æŠ½å‡ºã‚’ä¸Šæ›¸ã</small>
        </label>

        <!-- <label class="field">
          <span class="label">ã‚µãƒ³ãƒ—ãƒ«ç”»åƒï¼ˆå˜ä½“ï¼‰</span>
          <input type="file" name="sample_icon" accept="image/*">
          <small class="muted">æ—§æ–¹å¼ã®å˜ä½“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ</small>
        </label> -->

        <!-- <label class="field">
          <span class="label">ã‚µãƒ³ãƒ—ãƒ«éŸ³å£°ï¼ˆå˜ä½“ï¼‰</span>
          <input type="file" name="sample_audio" accept="audio/*">
          <small class="muted">æ—§æ–¹å¼ã®å˜ä½“éŸ³å£°</small>
        </label>
      </div> -->

      <!-- <label class="field">
        <span class="label">ã‚µãƒ³ãƒ—ãƒ«ç”»åƒï¼ˆè¤‡æ•°è¿½åŠ ï¼‰</span>
        <input type="file" id="sample_images" name="sample_image" accept="image/*">
        <div id="preview_image" class="preview-list"></div>
      </label> -->

      <label class="field">
        <span class="label">ã‚µãƒ³ãƒ—ãƒ«éŸ³å£°ï¼ˆè¤‡æ•°è¿½åŠ ï¼‰</span>
        <input type="file" id="sample_audio" name="sample_audio" accept="audio/*">
        <div id="preview_audios" class="preview-list"></div>
      </label>
      <small class="muted">â€» ã“ã“ã§é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€æŠ½å‡ºã•ã‚ŒãŸã‚µãƒ³ãƒ—ãƒ«ã«ã€Œè¿½åŠ ã€ã•ã‚Œã¾ã™ï¼ˆæ—¢å­˜ã¯ä¿æŒï¼‰ã€‚</small>
    </section>

    <!-- é€ä¿¡ -->
    <div class="actions">
      <button id="submit-btn" class="btn primary" type="submit">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
       <a class="btn ghost" href="/">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
      <span id="uploading-tip" class="muted" style="display:none;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦ å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</span>
    </div>

    <!-- é€²æ—è¡¨ç¤º -->
    <div id="progress-wrap" class="progress-wrap" style="display:none;">
      <div class="progress">
        <div id="progress-bar" class="progress-bar" style="width:0%"></div>
      </div>
      <div class="progress-meta">
        <span id="progress-text">0%</span>
        <span id="progress-bytes" class="muted"></span>
      </div>
  </form>
</div>

<style>
  .page-title { font-size: 1.8rem; font-weight: 700; margin-bottom: .5rem; }
  .muted { color: #6b7280; font-size: .9rem; }
  .card { background: var(--card, #101114); border: 1px solid #24262b; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
  .field .label { display:block; font-weight:600; margin-bottom:6px; }
  .field input[type="text"], .field textarea, .field select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #31343a; background: #0b0c0f; color: #e5e7eb; }
  .field textarea { resize: vertical; }
  .req { color: #ef4444; }
  .actions { display:flex; align-items:center; gap: 12px; margin-top: 8px; }
  .btn { padding: 10px 16px; border-radius: 999px; border: 1px solid #2c2f35; background: #13141a; color: #e5e7eb; cursor:pointer; }
  .btn.primary { background: linear-gradient(135deg, #6ea8fe, #9b8cff); border-color: transparent; }
  .btn.ghost { background: transparent; }
  .dropzone { border: 2px dashed #30343c; border-radius: 16px; padding: 18px; background: #0b0d12; position: relative; }
  .dropzone input[type="file"] { width:100%; padding:12px; border-radius:10px; background:#0b0c0f; border:1px solid #31343a; color:#e5e7eb; }
  .dz-instructions { display:flex; gap: 14px; align-items:center; margin-top: 8px; color:#9ca3af; }
  .dz-icon { font-size: 1.6rem; }
  .dz-title { font-weight:700; }
  .dz-sub { font-size:.9rem; }
  .preview-list { margin-top: 8px; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap: 8px; }
  .chip { font-size:.85rem; background:#111318; border:1px solid #2b2f36; padding:6px 10px; border-radius:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  /* é€²æ—ãƒãƒ¼ */
  .progress-wrap { margin-top: 10px; }
  .progress { width:100%; height: 14px; background:#0f1116; border:1px solid #2c2f35; border-radius: 999px; overflow: hidden; }
  .progress-bar { height:100%; background: linear-gradient(90deg, #6ea8fe, #9b8cff); transition: width .15s ease; }
  .progress-meta { display:flex; gap:12px; align-items:center; margin-top:6px; }
  #progress-text { font-weight:700; }
</style>

<script>
(function(){
  const form = document.getElementById('upload-form');
  const submitBtn = document.getElementById('submit-btn');
  const tip = document.getElementById('uploading-tip');
  const pgWrap = document.getElementById('progress-wrap');
  const pgBar = document.getElementById('progress-bar');
  const pgText = document.getElementById('progress-text');
  const pgBytes = document.getElementById('progress-bytes');
  // äºŒé‡é€ä¿¡é˜²æ­¢ & ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦ã€è¡¨ç¤º
  form.addEventListener('submit', function(e){
    submitBtn.disabled = true;
    submitBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦';
    tip.style.display = 'inline';
  });
  form.addEventListener('submit', function(e){
    e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€ä¿¡ã‚’æŠ‘æ­¢ã—ã€XHRã§é€²æ—ã‚’å–å¾—
    submitBtn.disabled = true;
    submitBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦';
    tip.style.display = 'inline';
    pgWrap.style.display = 'block';

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    const fd = new FormData(form);

    // XHR ã§é€²æ—å–å¾—
    const xhr = new XMLHttpRequest();
    xhr.open('POST', form.action, true);

    // é€²æ—ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
    xhr.upload.onprogress = function (e) {
      if (e.lengthComputable) {
        const pct = Math.max(0, Math.min(100, Math.round((e.loaded / e.total) * 100)));
        const pctf = Math.max(0, Math.min(100, Math.round((e.loaded / e.total) * 100)));
        pgBar.style.width = pctf + '%';
        pgText.textContent = pct + '%';
        const mb = (e.loaded / (1024*1024)).toFixed(1);
        const mbTot = (e.total / (1024*1024)).toFixed(1);
        pgBytes.textContent = `${mb}MB / ${mbTot}MB`;
      } else {
        pgText.textContent = 'é€ä¿¡ä¸­â€¦';
      }
    };

    // å®Œäº†æ™‚ï¼ˆ302 ã® Location ã‚’èª­ã‚“ã§é·ç§»ï¼‰
    xhr.onload = function () {
      try {
        // 302 ãŒè¿”ã‚‹æƒ³å®šã€‚Location ãŒã‚ã‚Œã°ãã“ã¸é·ç§»
        const loc = xhr.getResponseHeader('Location');
        if (loc) { window.location.assign(loc); return; }
        // Location ãŒãªã„/åŒä¸€ã‚ªãƒªã‚¸ãƒ³ã§ãªã„ç­‰ã€ä¿é™ºã¨ã—ã¦ãƒˆãƒƒãƒ—ã¸
        window.location.assign('/');
      } catch (err) {
        console.error(err);
        submitBtn.disabled = false;
        submitBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
        tip.style.display = 'none';
        alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯å®Œäº†ã—ã¾ã—ãŸãŒã€é·ç§»ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒˆãƒƒãƒ—ã¸æˆ»ã‚Šã¾ã™ã€‚');
        window.location.assign('/');
      }
    };

    xhr.onerror = function () {
      submitBtn.disabled = false;
      submitBtn.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰';
      tip.style.display = 'none';
      alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    };

    xhr.send(fd);
  });
  // è¤‡æ•°é¸æŠãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒªã‚¹ãƒˆè¡¨ç¤ºï¼‰
  function bindPreview(inputId, previewId) {
    const input = document.getElementById(inputId);
    const box = document.getElementById(previewId);
    if (!input || !box) return;
    input.addEventListener('change', function(){
      box.innerHTML = '';
      if (!this.files) return;
      Array.from(this.files).forEach(f => {
        const div = document.createElement('div');
        div.className = 'chip';
        div.textContent = f.name + ' (' + Math.round(f.size/1024) + 'KB)';
        box.appendChild(div);
      });
    });
  }
  bindPreview('sample_image', 'preview_images');
  bindPreview('sample_audio', 'preview_audios');

  // ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œï¼ˆç°¡æ˜“ï¼‰
  const dz = document.getElementById('aivmx-drop');
  const inp = document.getElementById('aivmx');
  if (dz && inp) {
    ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => {
      e.preventDefault(); e.stopPropagation(); dz.style.borderColor = '#6ea8fe';
    }));
    ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => {
      e.preventDefault(); e.stopPropagation(); dz.style.borderColor = '#30343c';
    }));
    dz.addEventListener('drop', e => {
      const files = e.dataTransfer.files;
      if (files && files.length) { inp.files = files; }
    });
  }
})();
</script>
{% endblock %}
