{% extends "base.html" %}
{% block title %}モデルをアップロード{% endblock %}

{% block content %}
<div class="mx-auto max-w-4xl p-6">
  <h1 class="page-title">モデルをアップロード</h1>
  <p class="muted">
    AIVMXモデルファイル（.aivmx）をアップロードします。必要に応じて、手動のアイコン・サンプル画像／音声を追加できます。
    抽出に成功した場合は、.aivmx 内のアイコン・サンプルが自動で初期設定されます。
  </p>
<br>
  <form id="upload-form" class="form" method="post" action="/models/upload" enctype="multipart/form-data">
    <!-- 基本情報 -->
    <section class="section">
      <h2 class="section-title">基本情報</h2>
      <div class="grid-2">
        <label class="field">
          <span class="label">モデル名 <span class="req">*</span></span>
          <input type="text" name="name" required placeholder="例: Every1Koe JP Voice v1">
        </label>
        <br>
        <label class="field">
          <span class="label">ライセンス（テンプレート）</span>
          <select name="license_name" id="license_name">
            {% for key, label in license_templates.items() %}
              <option value="{{ key }}">{{ label }}（{{ key }}）</option>
            {% endfor %}
          </select>
          <small class="muted">テンプレートを選ぶと「ライセンス本文」は任意で追記・上書きできます。</small>
        </label>
        <br>
      </div>
      <br>
      <label class="field">
        <span class="label">説明文</span>
        <textarea name="description" rows="5" placeholder="モデルの概要、用途、注意点など"></textarea>
      </label>
      <br>
      <label class="field">
        <span class="label">ライセンス本文（任意）</span>
        <textarea name="license_text" id="license_text" rows="8" placeholder="テンプレート本文の追記や独自ライセンス本文を記載"></textarea>
      </label>
    </section>

    <!-- AIVMX ファイル -->
    <section class="section">
      <h2 class="section-title">AIVMX ファイル</h2>
      <div class="dropzone" id="aivmx-drop">
        <input type="file" id="aivmx" name="file" accept=".aivmx,application/zip" required>
        <div class="dz-instructions">
          <div class="dz-icon">📦</div>
          <div>
            <div class="dz-title">AIVMX を選択 / ドラッグ＆ドロップ</div>
            <div class="dz-sub">拡張子 .aivmx（ZIP互換）</div>
          </div>
        </div>
      </div>
      <small class="muted">※ アップロード後、自動的にアイコン・サンプル（画像/音声）やライセンスの抽出を試みます。</small>
    </section>

    <!-- 手動メディア（抽出に失敗/上書きしたい場合） -->
    <section class="section">
      <h2 class="section-title">手動メディア（任意）</h2>
      <div class="grid-3">
        <label class="field">
          <span class="label">モデルアイコン（単体）</span>
          <input type="file" name="icon" accept="image/*">
          <small class="muted">.aivmxのアイコン抽出を上書き</small>
        </label>

        <!-- <label class="field">
          <span class="label">サンプル画像（単体）</span>
          <input type="file" name="sample_icon" accept="image/*">
          <small class="muted">旧方式の単体プレビュー画像</small>
        </label> -->

        <!-- <label class="field">
          <span class="label">サンプル音声（単体）</span>
          <input type="file" name="sample_audio" accept="audio/*">
          <small class="muted">旧方式の単体音声</small>
        </label>
      </div> -->

      <!-- <label class="field">
        <span class="label">サンプル画像（複数追加）</span>
        <input type="file" id="sample_images" name="sample_image" accept="image/*">
        <div id="preview_image" class="preview-list"></div>
      </label> -->

      <label class="field">
        <span class="label">サンプル音声（複数追加）</span>
        <input type="file" id="sample_audio" name="sample_audio" accept="audio/*">
        <div id="preview_audios" class="preview-list"></div>
      </label>
      <small class="muted">※ ここで選択したファイルは、抽出されたサンプルに「追加」されます（既存は保持）。</small>
    </section>

    <!-- 送信 -->
    <div class="actions">
      <button id="submit-btn" class="btn primary" type="submit">アップロード</button>
       <a class="btn ghost" href="/">キャンセル</a>
      <span id="uploading-tip" class="muted" style="display:none;">アップロード中… 大きなファイルは時間がかかる場合があります</span>
    </div>

    <!-- 進捗表示 -->
    <div id="progress-wrap" class="progress-wrap" style="display:none;">
      <div class="progress">
        <div id="progress-bar" class="progress-bar" style="width:0%"></div>
      </div>
      <div class="progress-meta">
        <span id="progress-text">0%</span>
        <span id="progress-bytes" class="muted"></span>
      </div>
  </form>
</div>

<style>
  .page-title { font-size: 1.8rem; font-weight: 700; margin-bottom: .5rem; }
  .muted { color: #6b7280; font-size: .9rem; }
  .card { background: var(--card, #101114); border: 1px solid #24262b; border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
  .field .label { display:block; font-weight:600; margin-bottom:6px; }
  .field input[type="text"], .field textarea, .field select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #31343a; background: #0b0c0f; color: #e5e7eb; }
  .field textarea { resize: vertical; }
  .req { color: #ef4444; }
  .actions { display:flex; align-items:center; gap: 12px; margin-top: 8px; }
  .btn { padding: 10px 16px; border-radius: 999px; border: 1px solid #2c2f35; background: #13141a; color: #e5e7eb; cursor:pointer; }
  .btn.primary { background: linear-gradient(135deg, #6ea8fe, #9b8cff); border-color: transparent; }
  .btn.ghost { background: transparent; }
  .dropzone { border: 2px dashed #30343c; border-radius: 16px; padding: 18px; background: #0b0d12; position: relative; }
  .dropzone input[type="file"] { width:100%; padding:12px; border-radius:10px; background:#0b0c0f; border:1px solid #31343a; color:#e5e7eb; }
  .dz-instructions { display:flex; gap: 14px; align-items:center; margin-top: 8px; color:#9ca3af; }
  .dz-icon { font-size: 1.6rem; }
  .dz-title { font-weight:700; }
  .dz-sub { font-size:.9rem; }
  .preview-list { margin-top: 8px; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap: 8px; }
  .chip { font-size:.85rem; background:#111318; border:1px solid #2b2f36; padding:6px 10px; border-radius:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  /* 進捗バー */
  .progress-wrap { margin-top: 10px; }
  .progress { width:100%; height: 14px; background:#0f1116; border:1px solid #2c2f35; border-radius: 999px; overflow: hidden; }
  .progress-bar { height:100%; background: linear-gradient(90deg, #6ea8fe, #9b8cff); transition: width .15s ease; }
  .progress-meta { display:flex; gap:12px; align-items:center; margin-top:6px; }
  #progress-text { font-weight:700; }
</style>

<script>
(function(){
  const form = document.getElementById('upload-form');
  const submitBtn = document.getElementById('submit-btn');
  const tip = document.getElementById('uploading-tip');
  const pgWrap = document.getElementById('progress-wrap');
  const pgBar = document.getElementById('progress-bar');
  const pgText = document.getElementById('progress-text');
  const pgBytes = document.getElementById('progress-bytes');
  // 二重送信防止 & 「アップロード中…」表示
  form.addEventListener('submit', function(e){
    submitBtn.disabled = true;
    submitBtn.textContent = 'アップロード中…';
    tip.style.display = 'inline';
  });
  form.addEventListener('submit', function(e){
    e.preventDefault(); // デフォルト送信を抑止し、XHRで進捗を取得
    submitBtn.disabled = true;
    submitBtn.textContent = 'アップロード中…';
    tip.style.display = 'inline';
    pgWrap.style.display = 'block';

    // フォームデータを収集
    const fd = new FormData(form);

    // XHR で進捗取得
    const xhr = new XMLHttpRequest();
    xhr.open('POST', form.action, true);

    // 進捗（アップロード）
    xhr.upload.onprogress = function (e) {
      if (e.lengthComputable) {
        const pct = Math.max(0, Math.min(100, Math.round((e.loaded / e.total) * 100)));
        const pctf = Math.max(0, Math.min(100, Math.round((e.loaded / e.total) * 100)));
        pgBar.style.width = pctf + '%';
        pgText.textContent = pct + '%';
        const mb = (e.loaded / (1024*1024)).toFixed(1);
        const mbTot = (e.total / (1024*1024)).toFixed(1);
        pgBytes.textContent = `${mb}MB / ${mbTot}MB`;
      } else {
        pgText.textContent = '送信中…';
      }
    };

    // 完了時（302 の Location を読んで遷移）
    xhr.onload = function () {
      try {
        // 302 が返る想定。Location があればそこへ遷移
        const loc = xhr.getResponseHeader('Location');
        if (loc) { window.location.assign(loc); return; }
        // Location がない/同一オリジンでない等、保険としてトップへ
        window.location.assign('/');
      } catch (err) {
        console.error(err);
        submitBtn.disabled = false;
        submitBtn.textContent = 'アップロード';
        tip.style.display = 'none';
        alert('アップロードは完了しましたが、遷移に失敗しました。トップへ戻ります。');
        window.location.assign('/');
      }
    };

    xhr.onerror = function () {
      submitBtn.disabled = false;
      submitBtn.textContent = 'アップロード';
      tip.style.display = 'none';
      alert('アップロード中にネットワークエラーが発生しました。もう一度お試しください。');
    };

    xhr.send(fd);
  });
  // 複数選択プレビュー（ファイル名のリスト表示）
  function bindPreview(inputId, previewId) {
    const input = document.getElementById(inputId);
    const box = document.getElementById(previewId);
    if (!input || !box) return;
    input.addEventListener('change', function(){
      box.innerHTML = '';
      if (!this.files) return;
      Array.from(this.files).forEach(f => {
        const div = document.createElement('div');
        div.className = 'chip';
        div.textContent = f.name + ' (' + Math.round(f.size/1024) + 'KB)';
        box.appendChild(div);
      });
    });
  }
  bindPreview('sample_image', 'preview_images');
  bindPreview('sample_audio', 'preview_audios');

  // ドロップ対応（簡易）
  const dz = document.getElementById('aivmx-drop');
  const inp = document.getElementById('aivmx');
  if (dz && inp) {
    ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => {
      e.preventDefault(); e.stopPropagation(); dz.style.borderColor = '#6ea8fe';
    }));
    ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => {
      e.preventDefault(); e.stopPropagation(); dz.style.borderColor = '#30343c';
    }));
    dz.addEventListener('drop', e => {
      const files = e.dataTransfer.files;
      if (files && files.length) { inp.files = files; }
    });
  }
})();
</script>
{% endblock %}
